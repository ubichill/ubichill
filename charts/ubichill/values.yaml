# Default values for ubichill main application

# Global settings
global:
  imageRegistry: "ghcr.io"
  imagePullPolicy: Always
  compatibility:
    openshift:
      adaptSecurityContext: auto
  security:
    allowInsecureImages: true

# Worlds configuration
worlds:
  enabled: true
  # Custom worlds can be defined here
  # custom:
  #   my-custom-world:
  #     apiVersion: ubichill.com/v1alpha1
  #     kind: World
  #     metadata:
  #       name: my-custom-world
  #       version: "1.0.0"
  #     spec:
  #       displayName: "My Custom World"
  #       description: "A custom world"
  #       environment:
  #         backgroundColor: "#FF0000"
  custom: {}

# Backend application configuration
backend:
  enabled: true
  replicaCount: 2
  
  image:
    repository: "ubichill-backend"
    tag: "latest"
    pullPolicy: Always
  
  service:
    type: ClusterIP
    port: 3001
    targetPort: 3001
  
  # Resource management
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 200m
      memory: 256Mi
  
  # Auto-scaling configuration
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 8
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    
    # Scaling behavior
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 50
            periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 2
            periodSeconds: 15
        selectPolicy: Max
  
  # Health checks
  healthcheck:
    enabled: true
    path: "/health"
    livenessProbe:
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
  
  # Environment variables
  env:
    NODE_ENV: "production"
    PORT: "3001"
    CORS_ORIGIN: "http://localhost:3000"
    BETTER_AUTH_URL: "http://localhost:3001"
    # Database and Redis connections set by templates

  # Secret environment variables (rendered as Secret)
  secretEnv:
    BETTER_AUTH_SECRET: "replace-in-production"
    RESEND_API_KEY: "replace-with-resend-key"
  
  # Existing secret containing the secrets (skips secretEnv creation and injects it)
  existingSecret: ""

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# Frontend application configuration
frontend:
  enabled: true
  replicaCount: 2
  
  image:
    repository: "ubichill-frontend"
    tag: "latest" 
    pullPolicy: Always
  
  service:
    type: ClusterIP
    port: 3000
    targetPort: 3000
  
  # Resource management
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi
  
  # Auto-scaling configuration
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 6
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  # Health checks
  healthcheck:
    enabled: true
    path: "/"
    livenessProbe:
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    readinessProbe:
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
  
  # Environment variables
  env:
    NODE_ENV: "production"
    PORT: "3000"
    HOSTNAME: "0.0.0.0"
    # NEXT_PUBLIC_BACKEND_URL set by template
    # NEXT_PUBLIC_VIDEO_PLAYER_BACKEND_URL set by template

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL

# Shared Redis cache
redis:
  enabled: true
  architecture: standalone
  # Explicitly reset registry for this subchart to avoid inheriting 'ghcr.io' from global
  global:
    imageRegistry: ""
  image:
    registry: ""
    repository: docker.io/bitnami/redis
    tag: 7.2.4-debian-11-r2
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      size: 2Gi
    resources:
      limits:
        memory: 512Mi
        cpu: 500m
      requests:
        memory: 256Mi
        cpu: 100m
  
  # Redis configuration for production
  commonConfiguration: |-
    maxmemory 512mb
    maxmemory-policy allkeys-lru
    appendonly yes
    save 900 1
    save 300 10
    save 60 10000

# Database (optional)
postgresql:
  enabled: true  # Enable if using PostgreSQL
  global:
    imageRegistry: ""
  image:
    registry: ""
    repository: docker.io/bitnami/postgresql
    tag: "16.4.1-debian-12-r3"
  auth:
    enablePostgresUser: true
    postgresPassword: "ubichill-db-secret"
    existingSecret: ""
    database: "ubichill"
  primary:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      limits:
        memory: 1Gi
        cpu: 500m
      requests:
        memory: 256Mi
        cpu: 100m

# Ingress configuration
ingress:
  enabled: true
  className: "nginx"
  annotations: 
    # kubernetes.io/ingress.class: nginx
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
  # hosts: []
  # tls: []

# Service configuration
service:
  # Frontend service
  frontend:
    type: ClusterIP
    port: 3000
    annotations: {}
  
  # Backend service  
  backend:
    type: ClusterIP
    port: 3001
    annotations: {}

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Node affinity (optional - for multi-AZ deployment)
nodeAffinity:
  enabled: false
  preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      preference:
        matchExpressions:
        - key: topology.kubernetes.io/zone
          operator: In
          values:
          - us-west-2a
          - us-west-2b

# Tolerations (optional)
tolerations: []

# Node selector (optional)
nodeSelector: {}

# Monitoring and observability
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s

# Video Player Plugin (Subchart)
video-player:
  enabled: false # Default to disabled, enabled via values-dev/prod or ArgoCD
  # Other values will be inherited from the subchart's default values